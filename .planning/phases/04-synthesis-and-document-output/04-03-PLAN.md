---
phase: 04-synthesis-and-document-output
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - dc-due-diligence-desktop/commands/due-diligence.md
  - dc-due-diligence-desktop/skills/due-diligence/SKILL.md
autonomous: true
requirements:
  - OUTPUT-01
  - OUTPUT-02
  - OUTPUT-03

must_haves:
  truths:
    - "Orchestrator dispatches Risk Assessment agent after all domain agents complete (Wave 2)"
    - "Orchestrator dispatches Executive Summary agent after Risk Assessment completes (Wave 3a)"
    - "Orchestrator dispatches Client Summary agent after Executive Summary completes (Wave 3b)"
    - "Orchestrator converts 3 markdown reports to DOCX using pandoc with runtime fallback"
    - "Orchestrator creates output/ subfolder and places DOCX files there"
    - "Orchestrator displays verdict, key highlights, and file paths after pipeline completes"
    - "Orchestrator handles session resume for synthesis phase (skips completed agents)"
  artifacts:
    - path: "dc-due-diligence-desktop/commands/due-diligence.md"
      provides: "Complete orchestrator with synthesis dispatch and DOCX generation"
      contains: "risk-assessment-agent"
    - path: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      provides: "Updated skill file with synthesis and output capabilities documented"
      contains: "Wave 2"
  key_links:
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "dc-due-diligence-desktop/agents/risk-assessment-agent.md"
      via: "Task tool dispatch"
      pattern: "risk-assessment-agent"
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "dc-due-diligence-desktop/agents/executive-summary-agent.md"
      via: "Task tool dispatch"
      pattern: "executive-summary-agent"
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "dc-due-diligence-desktop/agents/client-summary-agent.md"
      via: "Task tool dispatch"
      pattern: "client-summary-agent"
---

<objective>
Add synthesis agent dispatch, DOCX generation, and completion UX to the orchestrator command and skill files.

Purpose: This plan wires the three new synthesis agents into the orchestrator's dispatch pipeline, adds Word document generation via pandoc, and implements the completion UX that shows the verdict and deliverable paths. It also updates the SKILL.md to reflect the full pipeline capabilities.

Output: Updated command file with Wave 2/3/4 dispatch logic and DOCX post-processing. Updated skill file documenting all 5 phases of the pipeline.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-synthesis-and-document-output/04-RESEARCH.md
@.planning/phases/04-synthesis-and-document-output/04-CONTEXT.md
@.planning/phases/04-synthesis-and-document-output/04-01-SUMMARY.md
@.planning/phases/04-synthesis-and-document-output/04-02-SUMMARY.md
@dc-due-diligence-desktop/commands/due-diligence.md
@dc-due-diligence-desktop/skills/due-diligence/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add synthesis dispatch and DOCX generation to orchestrator command</name>
  <files>dc-due-diligence-desktop/commands/due-diligence.md</files>
  <action>
Read the current dc-due-diligence-desktop/commands/due-diligence.md and add the synthesis wave dispatch, DOCX generation, and completion UX sections.

**Changes to make:**

1. **Update Orchestration Notes section:** Replace the "Future Capabilities (Phase 4+)" bullet points with documentation of the implemented synthesis pipeline. Add description of the three synthesis agents and DOCX output.

2. **Add Synthesis Agent Dispatch (Phase 4) section** after the "Domain Agent Dispatch (Phase 3)" section. This section defines Wave 2, Wave 3, and post-processing:

   **Wave 2: Risk Assessment**
   - Resume check: If `research/risk-assessment-report.md` exists and is > 500 bytes, skip
   - Read `agents/risk-assessment-agent.md`
   - Replace `${WORKSPACE_FOLDER}` with actual target folder path
   - Dispatch as Task tool call (single agent, not parallel)
   - Wait for completion before proceeding

   **Wave 3a: Executive Summary**
   - Resume check: If `EXECUTIVE_SUMMARY.md` exists in workspace root and is > 500 bytes, skip
   - Read `agents/executive-summary-agent.md`
   - Replace `${WORKSPACE_FOLDER}` with actual target folder path
   - Dispatch as Task tool call
   - Wait for completion before proceeding

   **Wave 3b: Client Summary**
   - Resume check: If `CLIENT_SUMMARY.md` exists in workspace root and is > 500 bytes, skip
   - Read `agents/client-summary-agent.md`
   - Replace `${WORKSPACE_FOLDER}` with actual target folder path
   - Dispatch as Task tool call
   - Wait for completion

3. **Add DOCX Generation section** (post-processing after all agents complete):

   ```bash
   TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
   mkdir -p "$TARGET_FOLDER/output"

   if command -v pandoc &> /dev/null; then
     echo "Converting reports to Word format..."

     if [ -f "$TARGET_FOLDER/EXECUTIVE_SUMMARY.md" ]; then
       pandoc -f markdown -t docx -o "$TARGET_FOLDER/output/executive-summary.docx" "$TARGET_FOLDER/EXECUTIVE_SUMMARY.md"
       echo "Created: output/executive-summary.docx"
     fi

     if [ -f "$TARGET_FOLDER/CLIENT_SUMMARY.md" ]; then
       pandoc -f markdown -t docx -o "$TARGET_FOLDER/output/client-summary.docx" "$TARGET_FOLDER/CLIENT_SUMMARY.md"
       echo "Created: output/client-summary.docx"
     fi

     if [ -f "$TARGET_FOLDER/research/risk-assessment-report.md" ]; then
       pandoc -f markdown -t docx -o "$TARGET_FOLDER/output/risk-assessment.docx" "$TARGET_FOLDER/research/risk-assessment-report.md"
       echo "Created: output/risk-assessment.docx"
     fi
   else
     echo ""
     echo "Note: pandoc not found. Word document generation skipped."
     echo "Install pandoc for DOCX output: brew install pandoc"
     echo "Markdown reports are available in the workspace folder."
   fi
   ```

4. **Add Completion UX section:**

   After DOCX generation (or after Client Summary if pandoc unavailable), display the completion output.

   The orchestrator must:
   a. Read the first few lines of EXECUTIVE_SUMMARY.md to extract the verdict (Pursue / Proceed with Caution / Pass) from the `**Verdict:**` line
   b. Extract 3-4 bullet points from the Key Strengths and Critical Concerns sections
   c. Display in this format:

   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    VERDICT: [Pursue / Proceed with Caution / Pass]
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Key Highlights:
   • [Strength or concern 1]
   • [Strength or concern 2]
   • [Strength or concern 3]
   • [Strength or concern 4]

   Deliverables:
   • [TARGET_FOLDER]/output/executive-summary.docx
   • [TARGET_FOLDER]/output/client-summary.docx
   • [TARGET_FOLDER]/output/risk-assessment.docx
   • [TARGET_FOLDER]/EXECUTIVE_SUMMARY.md
   • [TARGET_FOLDER]/CLIENT_SUMMARY.md
   • [TARGET_FOLDER]/research/risk-assessment-report.md

   9 domain reports available in: [TARGET_FOLDER]/research/
   ```

   If DOCX files were not generated (no pandoc), omit the .docx lines from the deliverables list.

5. **Update Session Resilience section:** Add synthesis phase checkpoint:

   ```bash
   TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
   TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

   # Check synthesis progress
   RA_DONE=false
   ES_DONE=false
   CS_DONE=false
   [ $(stat -f%z "$TARGET_FOLDER/research/risk-assessment-report.md" 2>/dev/null || echo 0) -gt 500 ] && RA_DONE=true
   [ $(stat -f%z "$TARGET_FOLDER/EXECUTIVE_SUMMARY.md" 2>/dev/null || echo 0) -gt 500 ] && ES_DONE=true
   [ $(stat -f%z "$TARGET_FOLDER/CLIENT_SUMMARY.md" 2>/dev/null || echo 0) -gt 500 ] && CS_DONE=true

   cat > "$TARGET_FOLDER/_dd_status.json" << EOF
   {
     "phase": "synthesis",
     "reports_complete": $(ls "$TARGET_FOLDER/research/"*-report.md 2>/dev/null | wc -l | tr -d ' '),
     "risk_assessment_complete": $RA_DONE,
     "executive_summary_complete": $ES_DONE,
     "client_summary_complete": $CS_DONE,
     "timestamp": "$TIMESTAMP"
   }
   EOF
   ```

   Add resume logic for synthesis phase to the existing checkpoint decision logic:
   - If phase is "synthesis" and `risk_assessment_complete` is true, skip Risk Assessment
   - If phase is "synthesis" and `executive_summary_complete` is true, skip Executive Summary
   - If phase is "synthesis" and `client_summary_complete` is true, skip Client Summary

6. **Add agent file references to the Domain Agent Dispatch section:**
   Add the 3 new synthesis agents to the agent file list:
   - `agents/risk-assessment-agent.md` -- Cross-domain risk synthesis (Wave 2)
   - `agents/executive-summary-agent.md` -- Scored executive summary with verdict (Wave 3)
   - `agents/client-summary-agent.md` -- External-facing client summary (Wave 3)

7. **Keep all existing content intact.** The Phase 1-3 sections (file discovery, inventory, categorization, routing, domain agent dispatch) must not be modified. Only add new sections and update the Orchestration Notes.
  </action>
  <verify>
grep -c "risk-assessment-agent" dc-due-diligence-desktop/commands/due-diligence.md && grep -c "executive-summary-agent" dc-due-diligence-desktop/commands/due-diligence.md && grep -c "client-summary-agent" dc-due-diligence-desktop/commands/due-diligence.md && grep -c "pandoc" dc-due-diligence-desktop/commands/due-diligence.md && grep -c "VERDICT" dc-due-diligence-desktop/commands/due-diligence.md && grep -c "output/" dc-due-diligence-desktop/commands/due-diligence.md
  </verify>
  <done>Command file references all 3 synthesis agents, includes pandoc DOCX generation with fallback, displays verdict with highlights and file paths, and has synthesis phase resume logic</done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md with full pipeline capabilities</name>
  <files>dc-due-diligence-desktop/skills/due-diligence/SKILL.md</files>
  <action>
Read the current dc-due-diligence-desktop/skills/due-diligence/SKILL.md and update it to reflect the complete pipeline including synthesis and output.

**Changes to make:**

1. **Update "Current Capabilities" section** to include Phase 4:

   Add after the "Domain Analysis (Phase 3)" subsection:

   ```
   ### Synthesis & Scoring (Phase 4)
   - Risk Assessment agent reads all 9 domain reports and identifies cross-cutting risks
   - Executive Summary agent scores all 10 reports using tiered rubric and produces Pursue / Proceed with Caution / Pass verdict
   - Client Summary agent produces external-facing document without internal scoring language
   - Synthesis agents run sequentially: Risk Assessment -> Executive Summary -> Client Summary
   - Each synthesis agent resumes from disk if its output already exists (> 500 bytes)

   ### Document Output (Phase 4)
   - Final deliverables converted to Word (.docx) format using pandoc
   - Three DOCX files placed in output/ subfolder: executive-summary.docx, client-summary.docx, risk-assessment.docx
   - Graceful fallback if pandoc is not installed (markdown-only output with user message)
   - Markdown versions available: EXECUTIVE_SUMMARY.md and CLIENT_SUMMARY.md in workspace root, risk-assessment-report.md in research/
   ```

2. **Update "Future Capabilities (Phase 4+)" section** to remove items now implemented. Change to:

   ```
   ## Future Capabilities (Phase 5)

   - Stress testing with large (50+ file) data rooms
   - Non-technical README and clean-machine install validation
   ```

3. **Update Dispatch Architecture section** to include full wave structure:

   ```
   ## Dispatch Architecture

   Full pipeline executes in waves:

   **Wave 1: Domain Analysis (Parallel)**
   9 domain agents dispatch concurrently via the Task tool:
   1. Power Agent — agents/power-agent.md
   2. Connectivity Agent — agents/connectivity-agent.md
   3. Water/Cooling Agent — agents/water-cooling-agent.md
   4. Land/Zoning Agent — agents/land-zoning-agent.md
   5. Ownership Agent — agents/ownership-agent.md
   6. Environmental Agent — agents/environmental-agent.md
   7. Commercials Agent — agents/commercials-agent.md
   8. Natural Gas Agent — agents/natural-gas-agent.md
   9. Market Comparables Agent — agents/market-comparables-agent.md

   **Wave 2: Risk Assessment (Sequential)**
   10. Risk Assessment Agent — agents/risk-assessment-agent.md
       Reads all 9 domain reports, identifies cross-cutting risks

   **Wave 3: Executive Summary + Client Summary (Sequential)**
   11. Executive Summary Agent — agents/executive-summary-agent.md
       Reads all 10 reports, applies scoring rubric, produces verdict
   12. Client Summary Agent — agents/client-summary-agent.md
       Reads executive summary + research reports, produces external document

   **Post-Processing: DOCX Generation**
   13. Convert EXECUTIVE_SUMMARY.md, CLIENT_SUMMARY.md, risk-assessment-report.md to Word format
       Output: output/executive-summary.docx, output/client-summary.docx, output/risk-assessment.docx
   ```

4. **Update Session Resilience Protocol section** to include synthesis phase:

   Add to the decision logic:
   ```
   - If _dd_status.json exists AND phase is "synthesis" → check which synthesis reports exist (> 500 bytes), dispatch only missing agents, then run DOCX generation
   ```

   Add to checkpoint phases:
   ```
   - "synthesis" — domain agents complete, synthesis agents dispatched, check individual report existence for resume
   ```

5. **Keep all existing content that is still accurate.** Phase 1-3 documentation remains unchanged. Only update/add Phase 4 sections and the dispatch architecture.
  </action>
  <verify>
grep -c "Risk Assessment" dc-due-diligence-desktop/skills/due-diligence/SKILL.md && grep -c "Executive Summary" dc-due-diligence-desktop/skills/due-diligence/SKILL.md && grep -c "Client Summary" dc-due-diligence-desktop/skills/due-diligence/SKILL.md && grep -c "Wave 2" dc-due-diligence-desktop/skills/due-diligence/SKILL.md && grep -c "pandoc" dc-due-diligence-desktop/skills/due-diligence/SKILL.md && grep -c "synthesis" dc-due-diligence-desktop/skills/due-diligence/SKILL.md
  </verify>
  <done>SKILL.md documents full pipeline (Waves 1-3 + post-processing), references all 12 agents, includes synthesis phase in dispatch architecture and session resilience, and notes pandoc DOCX generation with fallback</done>
</task>

</tasks>

<verification>
1. Command file dispatches Risk Assessment, Executive Summary, and Client Summary agents sequentially
2. Command file includes pandoc DOCX generation with runtime fallback
3. Command file displays verdict, highlights, and deliverable paths after completion
4. Command file has synthesis phase resume logic in checkpoint system
5. SKILL.md documents complete Wave 1/2/3 + post-processing dispatch architecture
6. SKILL.md lists all 12 agents (9 domain + 3 synthesis)
7. SKILL.md documents DOCX output in output/ subfolder
8. SKILL.md includes synthesis phase in session resilience protocol
9. All existing Phase 1-3 content preserved in both files
</verification>

<success_criteria>
- Orchestrator command file ready to execute the full pipeline end-to-end
- SKILL.md accurately documents the complete pipeline capabilities
- Sequential dispatch ensures Risk Assessment completes before Executive Summary, and Executive Summary before Client Summary
- DOCX generation handles missing pandoc gracefully
- Completion UX shows verdict prominently with highlights and file paths
- Session resume works for synthesis phase (skips completed agents)
</success_criteria>

<output>
After completion, create `.planning/phases/04-synthesis-and-document-output/04-03-SUMMARY.md`
</output>

---
phase: 03-domain-analysis-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dc-due-diligence-desktop/agents/power-agent.md
  - dc-due-diligence-desktop/agents/connectivity-agent.md
  - dc-due-diligence-desktop/agents/water-cooling-agent.md
  - dc-due-diligence-desktop/commands/due-diligence.md
  - dc-due-diligence-desktop/skills/due-diligence/SKILL.md
autonomous: true
requirements: [DOMAIN-01, DOMAIN-02, DOMAIN-03, DOMAIN-10, DOMAIN-11, DOMAIN-12]

must_haves:
  truths:
    - "Power agent file exists and contains the complete two-phase research workflow adapted for Cowork"
    - "Connectivity agent file exists and contains domain-specific extraction categories and verification sources"
    - "Water/Cooling agent file exists and contains domain-specific extraction categories and verification sources"
    - "Orchestrator dispatches agents in parallel via Task tool, skipping domains with existing reports > 500 bytes"
    - "Each agent reads files from _dd_inventory.json domain routing, not from workspace root"
    - "Document Safety Protocol appears at the top of every agent file, verbatim from CLI version"
  artifacts:
    - path: "dc-due-diligence-desktop/agents/power-agent.md"
      provides: "Power domain analysis agent for Cowork"
      contains: "Document Safety Protocol"
    - path: "dc-due-diligence-desktop/agents/connectivity-agent.md"
      provides: "Connectivity domain analysis agent for Cowork"
      contains: "Document Safety Protocol"
    - path: "dc-due-diligence-desktop/agents/water-cooling-agent.md"
      provides: "Water/Cooling domain analysis agent for Cowork"
      contains: "Document Safety Protocol"
    - path: "dc-due-diligence-desktop/commands/due-diligence.md"
      provides: "Phase 3 dispatch block in orchestrator command"
      contains: "Domain Agent Dispatch"
    - path: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      provides: "Phase 3 resume logic and agent descriptions"
      contains: "analysis"
  key_links:
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "dc-due-diligence-desktop/agents/*.md"
      via: "Task tool dispatch reads agent file and passes content as task description"
      pattern: "agents/.*-agent\\.md"
    - from: "dc-due-diligence-desktop/agents/power-agent.md"
      to: "_dd_inventory.json"
      via: "Agent reads domains.power.files[] from inventory"
      pattern: "domains\\.power\\.files"
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "research/*-report.md"
      via: "Resume logic checks report file size > 500 bytes before dispatch"
      pattern: "stat.*report\\.md"
---

<objective>
Port the first 3 domain agents (Power, Connectivity, Water/Cooling) from CLI to Cowork format, and build the orchestrator dispatch logic that all 9 agents will use.

Purpose: This plan establishes the agent file pattern and orchestrator dispatch mechanism. Once these 3 agents work, Plans 02 and 03 follow the identical pattern with zero invention.
Output: 3 agent files in dc-due-diligence-desktop/agents/, Phase 3 dispatch block in command file, resume logic in SKILL.md
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-domain-analysis-agents/03-CONTEXT.md
@.planning/phases/03-domain-analysis-agents/03-RESEARCH.md
@.planning/phases/02-document-ingestion-and-routing/02-02-SUMMARY.md

# CLI reference agents (read these to port methodology — adapt file access pattern)
@dc-due-diligence/agents/power-agent.md
@dc-due-diligence/agents/connectivity-agent.md
@dc-due-diligence/agents/water-cooling-agent.md

# Report template (agents must follow this output format)
@dc-due-diligence/templates/agent-output-template.md

# Current orchestrator files (extend with Phase 3 dispatch)
@dc-due-diligence-desktop/commands/due-diligence.md
@dc-due-diligence-desktop/skills/due-diligence/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Power, Connectivity, and Water/Cooling agent files</name>
  <files>
    dc-due-diligence-desktop/agents/power-agent.md
    dc-due-diligence-desktop/agents/connectivity-agent.md
    dc-due-diligence-desktop/agents/water-cooling-agent.md
  </files>
  <action>
Create three agent markdown files in `dc-due-diligence-desktop/agents/`. For each agent, read the corresponding CLI reference agent at `dc-due-diligence/agents/{domain}-agent.md` and adapt it for Cowork. The adaptation requires these specific changes:

**Keep verbatim (copy exactly from CLI agent):**
- YAML frontmatter (name, description)
- Document Safety Protocol block — must appear BEFORE the "Your Task" section, not after
- Two-phase research workflow structure (Phase 1: Claim Extraction, Phase 2: Web Verification)
- All extraction categories with their keyword lists
- All verification sources with their WebSearch queries
- Verification Status Tags (VERIFIED, PARTIALLY_VERIFIED, NOT_VERIFIED, CONTRADICTED)
- Confidence Score Calculation rules
- Traffic Light Rules
- Key Reminders
- Terminology Normalization table
- Key Questions Instructions
- Output Format section (reference the template structure, not the CLI plugin path)

**Replace (adapt for Cowork):**
- Replace `${OPPORTUNITY_FOLDER}` with `${WORKSPACE_FOLDER}` everywhere
- Replace `${OPPORTUNITY_FOLDER}/_converted/` with direct file reading from inventory JSON
- Replace "Read the manifest at `${OPPORTUNITY_FOLDER}/_converted/manifest.json`" with "Read `${WORKSPACE_FOLDER}/_dd_inventory.json`"
- Replace "Read ALL converted markdown files in `${OPPORTUNITY_FOLDER}/_converted/`" with "Extract the file list under `domains.{domain-key}.files[]` and read each file directly using the Read tool"
- Replace `${PLUGIN_DIR}/templates/agent-output-template.md` reference in Output Format with inline description of the required sections (agents cannot read from the plugin directory at runtime in Cowork)

**Remove (not available in Cowork):**
- All MCP tool references: ToolSearch, Firecrawl, Exa, Tavily — per locked decision, WebSearch/WebFetch only
- "Enhanced tools" section that references MCP servers
- Any reference to `_converted/` directory

**Add (new for Cowork):**
- "Your Task" section adapted per the pattern in 03-RESEARCH.md:
  1. Read `${WORKSPACE_FOLDER}/_dd_inventory.json`
  2. Extract file list from `domains.{domain-key}.files[]`
  3. Read each file directly using the Read tool (PDF, DOCX, XLSX, PPTX, images all read natively)
  4. If no files assigned, skip Phase 1 and proceed directly to Phase 2 web research
  5. Write report to `${WORKSPACE_FOLDER}/research/{domain-slug}-report.md`
- Context budget guidance: "For very large documents (100+ pages), focus on the first 50 pages and note remaining pages were not reviewed"
- Explicit instruction: "Do NOT read files from the workspace root. Read ONLY the files listed in your domain's inventory entry."

**Domain keys for inventory JSON:**
- power-agent.md: `domains.power.files[]`, output: `research/power-report.md`
- connectivity-agent.md: `domains.connectivity.files[]`, output: `research/connectivity-report.md`
- water-cooling-agent.md: `domains.water-cooling.files[]`, output: `research/water-cooling-report.md`

**Validation after writing each file:**
- Confirm YAML frontmatter has `name` and `description`
- Confirm Document Safety Protocol block is present and appears before "Your Task"
- Confirm no `_converted/` references remain
- Confirm no MCP tool references remain (no ToolSearch, Firecrawl, Exa, Tavily)
- Confirm `${WORKSPACE_FOLDER}` is used (not `${OPPORTUNITY_FOLDER}`)
- Confirm output path uses `research/{domain}-report.md`
  </action>
  <verify>
    <automated>
cd /Users/noahrasheta/Dev/GitHub/shipfast && \
for agent in power connectivity water-cooling; do \
  FILE="dc-due-diligence-desktop/agents/${agent}-agent.md"; \
  echo "=== $agent ===" && \
  test -f "$FILE" && echo "EXISTS: yes" || echo "EXISTS: NO" && \
  head -3 "$FILE" | grep -q "^---" && echo "FRONTMATTER: yes" || echo "FRONTMATTER: NO" && \
  grep -q "Document Safety Protocol" "$FILE" && echo "SAFETY: yes" || echo "SAFETY: NO" && \
  grep -q "_dd_inventory.json" "$FILE" && echo "INVENTORY_REF: yes" || echo "INVENTORY_REF: NO" && \
  grep -q "WORKSPACE_FOLDER" "$FILE" && echo "WORKSPACE_VAR: yes" || echo "WORKSPACE_VAR: NO" && \
  (grep -q "_converted" "$FILE" && echo "CONVERTED_REF: FAIL — still has _converted" || echo "NO_CONVERTED: yes") && \
  (grep -qi "ToolSearch\|firecrawl\|tavily\|exa" "$FILE" && echo "MCP_REF: FAIL — still has MCP tools" || echo "NO_MCP: yes"); \
done
    </automated>
    <manual>Spot-check that the Document Safety Protocol block appears before the "Your Task" section in each file</manual>
  </verify>
  <done>
Three agent files exist at dc-due-diligence-desktop/agents/{power,connectivity,water-cooling}-agent.md. Each has YAML frontmatter, Document Safety Protocol verbatim from CLI, two-phase research workflow adapted for Cowork file reading, no _converted/ or MCP references, and writes output to research/{domain}-report.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 3 dispatch block to orchestrator command and SKILL.md</name>
  <files>
    dc-due-diligence-desktop/commands/due-diligence.md
    dc-due-diligence-desktop/skills/due-diligence/SKILL.md
  </files>
  <action>
Extend both orchestrator files with Phase 3 domain agent dispatch logic. Read each file first, then append/update the relevant sections.

**In commands/due-diligence.md — add a new section after the "Routing Checkpoint" section and before the "Parallel Dispatch Smoke Test" section:**

Add a `## Domain Agent Dispatch (Phase 3)` section containing:

1. **Research folder creation** — bash block:
```bash
TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
mkdir -p "$TARGET_FOLDER/research"
echo "Research folder ready: $TARGET_FOLDER/research"
```

2. **Resume check with file size validation** — bash block that iterates all 9 domains (power, connectivity, water-cooling, land-zoning, ownership, environmental, commercials, natural-gas, market-comparables), checks if `research/{domain}-report.md` exists AND is > 500 bytes (per Pitfall 5 from research). Reports SKIP or DISPATCH for each.

3. **Parallel dispatch instructions** — markdown block explaining:
   - For each domain that needs to run, read the agent file at `agents/{domain}-agent.md`
   - Pass the agent file content as the task description to the Task tool, with `${WORKSPACE_FOLDER}` replaced by the actual target folder path (per Open Question 1 from research — embed path explicitly, do not rely on variable inheritance)
   - Dispatch all agents that need to run simultaneously using parallel Task tool calls
   - Each agent writes its report to `research/{domain}-report.md` when complete

4. **Progress feedback** — instruct the orchestrator to:
   - Before dispatch: display a status table showing which agents will run vs. skip
   - After all agents complete: display completion summary with report file sizes
   - Count completed reports and display "X of 9 domain reports complete"

5. **Checkpoint update** — bash block that updates `_dd_status.json` to `"phase": "analysis"` with `reports_complete` count and timestamp

**In skills/due-diligence/SKILL.md — update the following sections:**

1. **Current Capabilities** — add a new subsection:
```markdown
### Domain Analysis (Phase 3)
- Dispatch 9 domain agents in parallel via Task tool
- Each agent reads assigned documents from _dd_inventory.json routing
- Each agent conducts web research using built-in WebSearch/WebFetch
- Each agent writes report to research/{domain}-report.md
- Resume: skip agents whose reports already exist (> 500 bytes)
- Document Safety Protocol in every agent prevents prompt injection
```

2. **Session Resilience Protocol decision logic** — add a new condition:
   - If `_dd_status.json` exists AND is less than 24 hours old AND `phase` is "analysis" → check which domain reports exist (> 500 bytes), dispatch only missing agents

3. **Checkpoint phases** — add `"analysis"` to the list:
   - `"analysis"` — domain agents dispatched, check report file existence for resume

4. **Update "Future Capabilities" section** — move the domain agent dispatch bullet from "Future Capabilities" to "Current Capabilities" since it's now implemented. Keep Risk Assessment, Executive Summary, Client Summary, and Word/PDF output in Future Capabilities.

**Critical constraints:**
- Do NOT remove or modify existing sections (Phases 1 and 2 logic must remain intact)
- The "Automatic Dispatch" section at the end of the Routing section should flow naturally into the new Phase 3 section
- The Parallel Dispatch Smoke Test section must remain (it's a Phase 1 validation tool, not to be confused with Phase 3 dispatch)
  </action>
  <verify>
    <automated>
cd /Users/noahrasheta/Dev/GitHub/shipfast && \
CMD="dc-due-diligence-desktop/commands/due-diligence.md" && \
SKILL="dc-due-diligence-desktop/skills/due-diligence/SKILL.md" && \
echo "=== Command File ===" && \
grep -q "Domain Agent Dispatch" "$CMD" && echo "DISPATCH_SECTION: yes" || echo "DISPATCH_SECTION: NO" && \
grep -q "mkdir -p.*research" "$CMD" && echo "MKDIR: yes" || echo "MKDIR: NO" && \
grep -q "500" "$CMD" && echo "SIZE_CHECK: yes" || echo "SIZE_CHECK: NO" && \
grep -q '"analysis"' "$CMD" && echo "ANALYSIS_PHASE: yes" || echo "ANALYSIS_PHASE: NO" && \
grep -q "agents/.*-agent.md" "$CMD" && echo "AGENT_FILE_REF: yes" || echo "AGENT_FILE_REF: NO" && \
echo "=== SKILL.md ===" && \
grep -q "Domain Analysis" "$SKILL" && echo "DOMAIN_ANALYSIS: yes" || echo "DOMAIN_ANALYSIS: NO" && \
grep -q '"analysis"' "$SKILL" && echo "ANALYSIS_RESUME: yes" || echo "ANALYSIS_RESUME: NO" && \
grep -q "Document Safety Protocol" "$SKILL" && echo "SAFETY_REF: yes" || echo "SAFETY_REF: NO"
    </automated>
  </verify>
  <done>
commands/due-diligence.md has a Phase 3 dispatch section with research folder creation, size-based resume check, parallel Task tool dispatch instructions, progress feedback, and analysis checkpoint. SKILL.md has Domain Analysis capability, "analysis" phase in resume logic, and agent descriptions updated. All Phase 1 and 2 logic is preserved.
  </done>
</task>

</tasks>

<verification>
Full pipeline validation:
1. All 3 agent files exist and pass structural checks (frontmatter, safety protocol, inventory reference, no legacy patterns)
2. Orchestrator command file has Phase 3 dispatch section that creates research folder, checks resume state, dispatches agents, updates checkpoint
3. SKILL.md reflects Phase 3 capabilities and supports "analysis" phase resume
4. No file conflicts with Phase 1 or Phase 2 logic (grep for key Phase 1/2 sections still present)
</verification>

<success_criteria>
- 3 agent files created: power-agent.md, connectivity-agent.md, water-cooling-agent.md
- Each agent has: YAML frontmatter, Document Safety Protocol, two-phase workflow, inventory-based file reading, report output path
- Orchestrator dispatch logic handles all 9 domains (not just the 3 created in this plan)
- Resume logic checks file size > 500 bytes, not just existence
- Checkpoint updated to "analysis" phase after dispatch
- No _converted/ or MCP tool references in any new content
</success_criteria>

<output>
After completion, create `.planning/phases/03-domain-analysis-agents/03-01-SUMMARY.md`
</output>

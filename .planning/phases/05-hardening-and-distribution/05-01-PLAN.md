---
phase: 05-hardening-and-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dc-due-diligence-desktop/commands/due-diligence.md
  - dc-due-diligence-desktop/skills/due-diligence/SKILL.md
autonomous: true
requirements:
  - INFRA-04
must_haves:
  truths:
    - "After Wave 1 completes, the user sees exactly which domains produced reports and which failed, with byte counts"
    - "If any domain agent fails, the user is told they can re-run /due-diligence and only failed agents will retry"
    - "Before agent dispatch on a large data room (30+ files), the user sees an estimated duration warning"
    - "SKILL.md no longer contains a 'Future Capabilities (Phase 5)' placeholder"
  artifacts:
    - path: "dc-due-diligence-desktop/commands/due-diligence.md"
      provides: "Enhanced post-Wave-1 validation with per-domain status, failure messaging, pre-dispatch size warning"
      contains: "Warning:"
    - path: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      provides: "Updated capabilities list reflecting hardening features, no Phase 5 stub"
  key_links:
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "Wave 1 completion check"
      via: "Enhanced domain results section with failure detection and retry messaging"
      pattern: "FAILED_DOMAINS"
---

<objective>
Harden the orchestrator for large data rooms by adding defensive error reporting, pre-dispatch warnings, and clear retry messaging when agents fail.

Purpose: The orchestrator already handles large data rooms architecturally (sub-agent isolation, batch ceiling, resume checks). The gap is that failures and progress are not surfaced clearly to the user — a missing agent report is silent, and large data rooms give no duration estimate. This plan closes the UX gap.

Output: Modified `commands/due-diligence.md` with enhanced completion validation and pre-dispatch warnings. Updated `skills/due-diligence/SKILL.md` with current capabilities and no Phase 5 placeholder.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-hardening-and-distribution/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pre-dispatch data room size warning and enhanced post-Wave-1 validation to orchestrator</name>
  <files>dc-due-diligence-desktop/commands/due-diligence.md</files>
  <action>
Modify the orchestrator command file to add two defensive UX improvements:

**1. Pre-dispatch large data room warning (insert BEFORE the "Parallel Agent Dispatch" section):**

Add a new section "## Pre-Dispatch Data Room Assessment" between the "Resume Check" section and the "Parallel Agent Dispatch" section. This section should:
- Read `_dd_inventory.json` to get `total_files` count
- If total_files > 30, display a warning with estimated completion time (20-40 minutes)
- Check if any domain has > 20 files (batched domains) and note that in the warning
- If total_files <= 30, display nothing extra (normal flow)

Use the bash block from research Pattern 2:
```bash
TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
TOTAL_FILES=$(jq '.total_files // 0' "$TARGET_FOLDER/_dd_inventory.json" 2>/dev/null || echo 0)
if [ "$TOTAL_FILES" -gt 30 ]; then
  BATCHED_DOMAINS=$(jq '[.domains | to_entries[] | select(.value.count > 20)] | length' "$TARGET_FOLDER/_dd_inventory.json" 2>/dev/null || echo 0)
  echo "Data room size: $TOTAL_FILES files."
  if [ "$BATCHED_DOMAINS" -gt 0 ]; then
    echo "$BATCHED_DOMAINS domain(s) have more than 20 files and will run in multiple passes."
  fi
  echo "Estimated completion: 20-40 minutes depending on file complexity and web research."
  echo ""
fi
```

**2. Enhanced post-Wave-1 completion validation (replace the existing "Domain Agent Results" bash block in the completion summary after agents complete):**

Replace the current simple completion check with an enhanced version that:
- Shows per-domain status with byte counts for completed reports
- Explicitly names failed/missing domains
- Tells the user that missing domains will be scored as unavailable in synthesis
- Tells the user they can re-run `/due-diligence` to retry only failed agents

Use the bash block from research Pattern 1:
```bash
TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
echo "=== Domain Agent Results ==="
COMPLETE_COUNT=0
FAILED_DOMAINS=""
for domain in power connectivity water-cooling land-zoning ownership environmental commercials natural-gas market-comparables; do
  REPORT="$TARGET_FOLDER/research/${domain}-report.md"
  SIZE=$(stat -f%z "$REPORT" 2>/dev/null || echo 0)
  if [ "$SIZE" -gt 500 ]; then
    echo "  $domain: Complete (${SIZE} bytes)"
    COMPLETE_COUNT=$((COMPLETE_COUNT + 1))
  else
    echo "  $domain: MISSING or incomplete"
    FAILED_DOMAINS="$FAILED_DOMAINS $domain"
  fi
done

if [ -n "$FAILED_DOMAINS" ]; then
  echo ""
  echo "Warning: $((9 - COMPLETE_COUNT)) domain agent(s) did not produce a report."
  echo "Affected domains:$FAILED_DOMAINS"
  echo "These domains will be marked as unavailable in the Executive Summary."
  echo "To retry failed domains only, run /due-diligence again — completed reports will be kept."
fi
echo ""
echo "$COMPLETE_COUNT of 9 domain reports complete. Proceeding to synthesis."
```

Also add text instruction after the enhanced bash block telling the orchestrator: "If any domains failed, display the warning message above. Then proceed to synthesis regardless — synthesis agents handle missing reports gracefully (SYNTH-05)."

Do NOT modify any other sections of the file (file discovery, categorization, routing, synthesis dispatch, DOCX generation, completion UX, or smoke test sections remain unchanged).
  </action>
  <verify>
    <automated>grep -c "FAILED_DOMAINS" dc-due-diligence-desktop/commands/due-diligence.md | grep -q "[1-9]" && grep -c "Estimated completion" dc-due-diligence-desktop/commands/due-diligence.md | grep -q "[1-9]" && echo "PASS" || echo "FAIL"</automated>
    <manual>Read the modified file and confirm: (1) pre-dispatch warning section exists before agent dispatch, (2) enhanced completion check with failure naming exists after Wave 1, (3) retry messaging tells user to re-run /due-diligence</manual>
  </verify>
  <done>Orchestrator command file contains pre-dispatch data room size warning (30+ files triggers estimate) and enhanced post-Wave-1 validation that names failed domains and suggests retry</done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md to reflect hardening capabilities and remove Phase 5 stub</name>
  <files>dc-due-diligence-desktop/skills/due-diligence/SKILL.md</files>
  <action>
Modify SKILL.md with two changes:

**1. Remove the "Future Capabilities (Phase 5)" section entirely.** Delete the section header and its two bullet points ("Stress testing with large (50+ file) data rooms" and "Non-technical README and clean-machine install validation"). These capabilities are now implemented or in the process of being implemented — they should not remain as a future stub.

**2. Add a new section "### Hardening (Phase 5)" under "## Current Capabilities" (after the "### Document Output (Phase 4)" section).** Content:

```markdown
### Hardening (Phase 5)
- Pre-dispatch data room size warning for large data rooms (30+ files) with estimated completion time
- Enhanced post-Wave-1 validation with per-domain status reporting (complete vs missing)
- Explicit failure messaging: names affected domains, explains impact on scoring, and suggests retry
- Retry via re-run: `/due-diligence` automatically skips completed agents and retries only failed ones
```

No other changes to SKILL.md.
  </action>
  <verify>
    <automated>grep -c "Future Capabilities" dc-due-diligence-desktop/skills/due-diligence/SKILL.md | grep -q "^0$" && grep -c "Hardening (Phase 5)" dc-due-diligence-desktop/skills/due-diligence/SKILL.md | grep -q "[1-9]" && echo "PASS" || echo "FAIL"</automated>
    <manual>Confirm SKILL.md has no "Future Capabilities" section and has a new "Hardening (Phase 5)" section under Current Capabilities</manual>
  </verify>
  <done>SKILL.md lists hardening features as current capabilities and contains no Phase 5 placeholder stub</done>
</task>

</tasks>

<verification>
1. `grep -c "FAILED_DOMAINS" dc-due-diligence-desktop/commands/due-diligence.md` returns >= 1
2. `grep -c "Estimated completion" dc-due-diligence-desktop/commands/due-diligence.md` returns >= 1
3. `grep -c "Future Capabilities" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` returns 0
4. `grep -c "Hardening" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` returns >= 1
5. No new files created — only existing files modified
</verification>

<success_criteria>
- Orchestrator has pre-dispatch warning for data rooms with 30+ files
- Orchestrator names failed domains after Wave 1 and suggests retry
- SKILL.md reflects current hardening capabilities with no future stubs
- All existing functionality (discovery, routing, dispatch, synthesis, DOCX, completion UX) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05-hardening-and-distribution/05-01-SUMMARY.md`
</output>

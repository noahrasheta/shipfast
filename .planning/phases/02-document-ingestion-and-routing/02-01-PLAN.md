---
phase: 02-document-ingestion-and-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dc-due-diligence-desktop/commands/due-diligence.md
  - dc-due-diligence-desktop/skills/due-diligence/SKILL.md
autonomous: true
requirements: [INGEST-01, INGEST-02, INGEST-03, INGEST-05]

must_haves:
  truths:
    - "Orchestrator discovers and lists all PDF, DOCX, XLSX, PPTX, image, and text-based files in the workspace folder"
    - "Orchestrator reads a scanned PDF or image file using Claude's native vision capabilities without Python"
    - "A JSON inventory file (_dd_inventory.json) is written to disk before any domain agent dispatch"
    - "Chat output shows summary counts only (total + per-type), not full file listings"
    - "Text-based files (.csv, .txt, .eml) are included in discovery as best-effort extensions"
  artifacts:
    - path: "dc-due-diligence-desktop/commands/due-diligence.md"
      provides: "Expanded file discovery with extended types, inventory JSON write, and content reading instructions"
      contains: "_dd_inventory.json"
    - path: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      provides: "Updated orchestrator with Phase 2 document ingestion capabilities"
      contains: "Document Ingestion"
  key_links:
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "_dd_inventory.json"
      via: "bash heredoc write after file discovery"
      pattern: "_dd_inventory\\.json"
    - from: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      to: "dc-due-diligence-desktop/commands/due-diligence.md"
      via: "orchestrator references command file patterns"
      pattern: "inventory"
---

<objective>
Expand the Phase 1 file discovery stub into a full document ingestion pipeline that reads all supported file types natively and writes a structured JSON inventory to disk.

Purpose: INGEST-01/02/03/05 require the orchestrator to read all document types (PDF, DOCX, XLSX, PPTX, images, scanned docs) and create a complete inventory before agents are dispatched. This plan builds the ingestion foundation that Plan 02-02 adds routing logic on top of.

Output: Updated commands/due-diligence.md and skills/due-diligence/SKILL.md with expanded file discovery, native document reading instructions, and _dd_inventory.json write logic.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-ingestion-and-routing/02-RESEARCH.md
@.planning/phases/02-document-ingestion-and-routing/02-CONTEXT.md
@.planning/phases/01-foundation-and-validation/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-validation/01-02-SUMMARY.md
@dc-due-diligence-desktop/commands/due-diligence.md
@dc-due-diligence-desktop/skills/due-diligence/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand file discovery and add inventory JSON write to command file</name>
  <files>dc-due-diligence-desktop/commands/due-diligence.md</files>
  <action>
  Replace the existing "Workspace File Discovery" section and "Session Resilience" section in commands/due-diligence.md. Keep the Phase 1 stub removal (step 7 "[Phase 1 stub]") and replace it with new Phase 2 logic. Keep the Parallel Dispatch Smoke Test section unchanged.

  **Step 7 replacement** — Replace `[Phase 1 stub] Report that the document inventory is complete.` with:
  ```
  7. Categorize and route documents to domain agents. (Full routing logic added in Phase 2, Plan 02.)
  ```

  **Expand the file discovery bash block** to include text-based extensions:
  - Add `.csv`, `.txt`, `.eml` to the find command
  - Add `OTHER_COUNT` for text-based files using `grep -iEc "\.(csv|txt|eml)$"`
  - Exclude internal directories from find: `! -path "*/_converted/*" ! -path "*/research/*" ! -name "_dd_*"`
  - Keep the existing counting pattern (grep -ic for each type)

  **Add inventory JSON write section** AFTER file discovery, BEFORE session checkpoint:

  Add a new section `## Document Inventory` between file discovery results display and session resilience:

  ```markdown
  ## Document Inventory

  After file discovery, write a structured JSON inventory to disk. This file is consumed by domain agents in Phase 3.

  ```bash
  TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
  TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  # Build file list as JSON array (handle spaces in filenames)
  FILE_LIST_JSON=$(echo "$ALL_FILES" | while IFS= read -r f; do
    [ -z "$f" ] && continue
    printf '"%s",' "$f"
  done | sed 's/,$//')

  cat > "$TARGET_FOLDER/_dd_inventory.json" << INVENTORY_EOF
  {
    "generated": "$TIMESTAMP",
    "workspace_folder": "$TARGET_FOLDER",
    "total_files": $TOTAL_COUNT,
    "file_types": {
      "pdf": $PDF_COUNT,
      "docx": $DOCX_COUNT,
      "xlsx": $XLSX_COUNT,
      "pptx": $PPTX_COUNT,
      "images": $IMG_COUNT,
      "other": $OTHER_COUNT
    },
    "files": [$FILE_LIST_JSON],
    "domains": {},
    "uncategorized": [],
    "status": "inventory_complete"
  }
  INVENTORY_EOF
  echo "Inventory written to $TARGET_FOLDER/_dd_inventory.json"
  ```

  The `domains` and `uncategorized` fields start empty — Plan 02-02 populates them during categorization.
  ```

  **Add document reading instructions** section after inventory write:

  ```markdown
  ## Native Document Reading

  Claude Cowork reads all document types natively — no Python conversion pipeline needed:

  - **PDF files:** Use the Read tool directly. Claude extracts text content from text-based PDFs.
  - **DOCX files:** Use the Read tool. Claude reads Word documents and extracts text content.
  - **XLSX files:** Use the Read tool. Claude reads spreadsheet data as structured content.
  - **PPTX files:** Use the Read tool. Claude reads slide content as text.
  - **Images (JPG, JPEG, PNG):** Use the Read tool. Claude's vision capabilities interpret image content visually.
  - **Scanned PDFs:** If a PDF returns very little or no text via Read, it may be a scanned document. Use the Read tool — Claude's multimodal vision will interpret the page images directly.
  - **Text files (.csv, .txt, .eml):** Use the Read tool. These are read as plain text.

  For categorization purposes (Phase 2, Plan 02), read only the first page or first ~500 words of each document to determine its domain. Do NOT read entire documents during categorization — preserve context window for domain agents in Phase 3.
  ```

  **Update the session resilience checkpoint** to include `"phase": "inventory"` (unchanged) but also add the inventory file path:
  - Add `"inventory_file": "$TARGET_FOLDER/_dd_inventory.json"` to the _dd_status.json write

  **Update the Instructions section** steps:
  - Step 5: "Display a summary table grouped by file type with counts." (keep)
  - Step 6: "Write `_dd_inventory.json` to the target folder with the full file listing." (new)
  - Step 7: "Write `_dd_status.json` checkpoint." (was step 6)
  - Step 8: "Proceed to document categorization and routing (Plan 02-02 logic)." (new, replaces old step 7 stub)

  Keep the existing Parallel Dispatch Smoke Test section completely unchanged.
  </action>
  <verify>
  Run these checks:
  1. `grep -c "_dd_inventory.json" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 2 (write + reference)
  2. `grep -c "\.csv\|\.txt\|\.eml" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1 (extended types in find)
  3. `grep -c "Native Document Reading" dc-due-diligence-desktop/commands/due-diligence.md` — should return 1
  4. `grep -c "Parallel Dispatch Smoke Test" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1 (preserved)
  5. `grep -c "Phase 1 stub" dc-due-diligence-desktop/commands/due-diligence.md` — should return 0 (removed)
  </verify>
  <done>
  commands/due-diligence.md discovers all file types including .csv/.txt/.eml, writes _dd_inventory.json with file listing to disk, includes native document reading instructions for all types including scanned PDFs via vision, and the Phase 1 stub is replaced with Phase 2 routing placeholder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md orchestrator with Phase 2 ingestion capabilities</name>
  <files>dc-due-diligence-desktop/skills/due-diligence/SKILL.md</files>
  <action>
  Update skills/due-diligence/SKILL.md to reflect Phase 2 capabilities. This file is the orchestrator skill that coordinates the full workflow.

  **Update "Phase 1 Capabilities (Current)" section** — rename to "Current Capabilities" and expand:

  ```markdown
  ## Current Capabilities

  ### Document Discovery (Phase 1)
  - Scan workspace folder for document files (PDF, DOCX, XLSX, PPTX, images, CSV, TXT, EML)
  - Display file inventory with counts by type
  - Write status checkpoints to disk for session resilience
  - Resume interrupted sessions using `_dd_status.json`

  ### Document Ingestion (Phase 2)
  - Read all document types natively using Claude's built-in capabilities (no Python required)
  - Read scanned PDFs and images using Claude's vision/OCR capabilities
  - Write structured inventory JSON (`_dd_inventory.json`) to workspace before agent dispatch
  - Categorize documents into 9 domain buckets by content and filename analysis
  - Batch documents per domain to respect 20-file-per-chat platform limit
  - Route document batches to domain agents automatically (no user confirmation)
  ```

  **Update "Future Capabilities (Phase 2+)" section** — rename to "Future Capabilities (Phase 3+)" and remove ingestion items (they're now current):

  ```markdown
  ## Future Capabilities (Phase 3+)

  - Parallel domain agent dispatch (9 agents, Wave 1 — concurrent via Task tool)
  - Risk assessment synthesis
  - Executive summary generation with scoring
  - Client summary for deal presenter
  - Word/PDF output generation
  ```

  **Update "Workspace File Discovery" bash block** to match the expanded version in commands/due-diligence.md:
  - Add .csv, .txt, .eml to find command
  - Add OTHER_COUNT
  - Add exclusion for _converted/, research/, and _dd_* files

  **Add "Document Inventory" section** after Workspace File Discovery:

  ```markdown
  ## Document Inventory

  After file discovery, write a structured JSON inventory to disk. This must happen BEFORE any domain agent is dispatched (INGEST-05 requirement).

  The inventory file `_dd_inventory.json` contains:
  - All discovered file paths
  - File type counts
  - Domain assignments (populated by categorization step)
  - Batch assignments (populated by routing step)
  - Uncategorized files list

  Domain agents in Phase 3 reference this file to know which documents to analyze.
  ```

  **Add "Native Document Reading" section** after Document Inventory:

  ```markdown
  ## Native Document Reading

  Claude Cowork reads all document types natively — no external dependencies:

  | File Type | How to Read | Notes |
  |-----------|-------------|-------|
  | PDF (text) | Read tool | Extracts text content directly |
  | PDF (scanned) | Read tool + vision | If text extraction returns little/no content, vision interprets page images |
  | DOCX | Read tool | Word document text extraction |
  | XLSX | Read tool | Spreadsheet data as structured content |
  | PPTX | Read tool | Slide content as text |
  | Images | Read tool | Vision capabilities interpret visual content |
  | CSV/TXT/EML | Read tool | Plain text reading |

  **Key principle:** No Python, no Tesseract, no external converters. Everything runs through Claude's native capabilities. This is the core advantage over the CLI version.
  ```

  **Update "Checkpoint Write" section** to add inventory_file field to the _dd_status.json schema.

  Keep all other sections (Dispatch Architecture, Session Resilience Protocol) unchanged.
  </action>
  <verify>
  Run these checks:
  1. `grep -c "Current Capabilities" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 1
  2. `grep -c "Phase 1 Capabilities" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 0 (renamed)
  3. `grep -c "_dd_inventory.json" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 2
  4. `grep -c "Native Document Reading" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 1
  5. `grep -c "Phase 3+" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 1
  6. `grep -c "\.csv\|\.txt\|\.eml" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 1
  </verify>
  <done>
  SKILL.md reflects Phase 2 ingestion capabilities: expanded file discovery, native document reading table, _dd_inventory.json documentation, and clear separation between current (Phase 1+2) and future (Phase 3+) capabilities.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **File discovery expansion:** The find command in both files includes .csv, .txt, .eml extensions alongside the 5 primary types
2. **Inventory JSON:** _dd_inventory.json write logic exists in commands/due-diligence.md with correct schema (generated, workspace_folder, total_files, file_types, files, domains, uncategorized, status)
3. **Native reading instructions:** Both files document how to read all file types natively (including scanned PDFs via vision)
4. **No Python:** Neither file references Python, pip, venv, or external converters
5. **Phase 1 stub removed:** No "[Phase 1 stub]" text remains in commands/due-diligence.md
6. **Smoke test preserved:** The Parallel Dispatch Smoke Test section is unchanged in commands/due-diligence.md
7. **Session resilience:** _dd_status.json checkpoint now includes inventory_file path
</verification>

<success_criteria>
- commands/due-diligence.md discovers all file types including text-based extensions
- _dd_inventory.json write logic produces valid JSON with file listing
- Both files document native reading for all types including scanned PDFs
- No external dependencies introduced (no Python, no npm packages)
- Phase 1 session resilience and smoke test preserved
- SKILL.md clearly separates current vs future capabilities
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-ingestion-and-routing/02-01-SUMMARY.md`
</output>

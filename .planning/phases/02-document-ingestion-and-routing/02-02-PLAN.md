---
phase: 02-document-ingestion-and-routing
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - dc-due-diligence-desktop/commands/due-diligence.md
  - dc-due-diligence-desktop/skills/due-diligence/SKILL.md
autonomous: true
requirements: [INGEST-04, INGEST-05]

must_haves:
  truths:
    - "Orchestrator categorizes each document into one of 9 domain buckets or marks it uncategorized"
    - "Each file is assigned to exactly one domain — no duplicates across domains"
    - "Uncategorized files are listed in chat output so the user can see what was excluded"
    - "When a domain has more than 20 files, they are split into batches of max 20"
    - "_dd_inventory.json is updated with domain assignments and batch metadata before any agent dispatch"
    - "No user confirmation prompt — categorization and routing happen automatically"
  artifacts:
    - path: "dc-due-diligence-desktop/commands/due-diligence.md"
      provides: "Domain categorization logic with keyword matching and batch splitting"
      contains: "Domain Categorization"
    - path: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      provides: "Updated orchestrator with routing workflow and domain keyword reference"
      contains: "Document Routing"
  key_links:
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "_dd_inventory.json"
      via: "jq update after categorization adds domain assignments"
      pattern: "domains"
    - from: "dc-due-diligence-desktop/commands/due-diligence.md"
      to: "dc-due-diligence-desktop/skills/due-diligence/SKILL.md"
      via: "command uses same 9-domain keyword sets defined in skill"
      pattern: "keyword"
---

<objective>
Build the document categorization and routing logic that assigns each file to one of 9 domain buckets, enforces the 20-file-per-dispatch batch limit, and updates the inventory JSON with routing metadata.

Purpose: INGEST-04 requires handling 50+ file data rooms with batching. INGEST-05 requires the inventory to be complete (including domain assignments) before agents are dispatched. This plan completes the Phase 2 pipeline — after this, the data room is fully categorized and ready for Phase 3 agent dispatch.

Output: Updated commands/due-diligence.md with categorization and batching logic, updated SKILL.md with domain keyword reference and routing workflow, and _dd_inventory.json schema populated with domain/batch data.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-ingestion-and-routing/02-RESEARCH.md
@.planning/phases/02-document-ingestion-and-routing/02-CONTEXT.md
@.planning/phases/02-document-ingestion-and-routing/02-01-SUMMARY.md
@dc-due-diligence-desktop/commands/due-diligence.md
@dc-due-diligence-desktop/skills/due-diligence/SKILL.md
@dc-due-diligence/skills/due-diligence/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add domain categorization and batch routing to command file</name>
  <files>dc-due-diligence-desktop/commands/due-diligence.md</files>
  <action>
  Add two new sections to commands/due-diligence.md AFTER the "Document Inventory" section and BEFORE the "Session Resilience" section: "Domain Categorization" and "Document Routing".

  **Add "## Domain Categorization" section:**

  This section implements a two-pass categorization approach per the research:

  ```markdown
  ## Domain Categorization

  After inventory is written, categorize each file into one of the 9 domain buckets. Use a two-pass approach to conserve context window:

  ### Pass 1: Filename and Path Heuristics

  For each file in the inventory, check the filename and parent directory name against domain keyword sets. This pass is fast and requires no file reading.

  Domain keyword sets for filename matching (case-insensitive):

  | Domain | Keywords |
  |--------|----------|
  | power | utility, substation, transformer, MW, megawatt, electrical, grid, voltage, redundancy, UPS, generator, switchgear, power purchase, PPA |
  | connectivity | fiber, carrier, latency, bandwidth, network, ISP, peering, dark fiber, lit services, cross-connect, route diversity, meet-me, telecom |
  | water-cooling | cooling, water, chiller, HVAC, airflow, temperature, humidity, PUE, WUE, cooling tower, mechanical |
  | land-zoning | zoning, parcel, entitlement, setback, easement, lot, acre, building permit, land use, variance, conditional use, survey, plat |
  | ownership | deed, title, lien, mortgage, LLC, owner, entity, beneficial, encumbrance, UCC, litigation, corporate |
  | environmental | contamination, hazardous, flood, seismic, Phase I, Phase II, remediation, brownfield, EPA, environmental impact, ESA |
  | commercials | lease, rent, NNN, CAM, tenant, escalation, term, option, pricing, rate, cost, revenue, EBITDA, financial, pro forma, LOI |
  | natural-gas | gas, pipeline, natural gas, BTU, therms, generation, turbine, fuel, backup power |
  | market-comparables | comparable, market rate, transaction, sale, acquisition, benchmark, competitor, vacancy, comp |

  If a filename matches keywords from exactly one domain, assign it. If it matches multiple domains, assign to the domain with the most keyword hits. If no keywords match, mark as "needs content inspection" for Pass 2.

  ### Pass 2: Content Inspection (only for unmatched files)

  For files that could not be categorized by filename alone, read the first page or first ~500 words using the Read tool. Apply the same keyword matching against the extracted content.

  If a scanned PDF or image returns no text, use Claude's vision to inspect the first page — look for letterheads, logos, table headers, or other visual cues that indicate the domain.

  If content inspection still doesn't yield a clear domain match, mark the file as "uncategorized" with reason "No domain keywords matched".

  ### Categorization Output

  After both passes complete:

  1. Display to chat (summary only per user decision):
  ```
  Documents categorized:
  - Power: X files
  - Connectivity: X files
  - Water & Cooling: X files
  - Land & Zoning: X files
  - Ownership: X files
  - Environmental: X files
  - Commercials: X files
  - Natural Gas: X files
  - Market Comparables: X files
  - Uncategorized: X files [list filenames if any]
  ```

  2. Each file assigned to exactly ONE domain or uncategorized — no duplicates.
  ```

  **Add "## Document Routing" section** after Domain Categorization:

  ```markdown
  ## Document Routing

  After categorization, prepare routing metadata for Phase 3 agent dispatch.

  ### Batch Splitting

  For each domain bucket, check if the file count exceeds 20 (the per-chat platform limit). If so, split into sequential batches of max 20 files each.

  ```bash
  # Batch splitting logic (conceptual — orchestrator implements this in Phase 3 dispatch)
  BATCH_SIZE=20
  for domain in power connectivity water-cooling land-zoning ownership environmental commercials natural-gas market-comparables; do
    DOMAIN_COUNT=$(jq -r ".domains.\"$domain\".count // 0" "$TARGET_FOLDER/_dd_inventory.json")
    if [ "$DOMAIN_COUNT" -gt "$BATCH_SIZE" ]; then
      BATCHES=$(( (DOMAIN_COUNT + BATCH_SIZE - 1) / BATCH_SIZE ))
      echo "$domain: $DOMAIN_COUNT files -> $BATCHES batches"
    else
      echo "$domain: $DOMAIN_COUNT files -> 1 batch"
    fi
  done
  ```

  ### Update Inventory JSON

  After categorization and batch assignment, update `_dd_inventory.json` with the routing metadata:

  The orchestrator must update the `domains` and `uncategorized` fields in `_dd_inventory.json`. For each domain:

  ```json
  "domains": {
    "power": {
      "files": ["/path/to/file1.pdf", "/path/to/file2.xlsx"],
      "count": 2,
      "batches": [
        {"batch": 1, "files": ["/path/to/file1.pdf", "/path/to/file2.xlsx"]}
      ]
    }
  }
  ```

  For uncategorized files:
  ```json
  "uncategorized": [
    {"path": "/path/to/mystery.pdf", "reason": "No domain keywords matched"}
  ]
  ```

  Update the `status` field from `"inventory_complete"` to `"routing_complete"`.

  ### Session Checkpoint Update

  After routing metadata is written, update `_dd_status.json`:

  ```bash
  TARGET_FOLDER="${ARGUMENTS:-$(pwd)}"
  TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  cat > "$TARGET_FOLDER/_dd_status.json" << EOF
  {
    "phase": "routing",
    "files_found": $TOTAL_COUNT,
    "files_categorized": $CATEGORIZED_COUNT,
    "files_uncategorized": $UNCATEGORIZED_COUNT,
    "inventory_file": "$TARGET_FOLDER/_dd_inventory.json",
    "timestamp": "$TIMESTAMP"
  }
  EOF
  echo "Routing checkpoint written."
  ```

  If a session resumes and `_dd_status.json` shows `"phase": "routing"`, skip directly to Phase 3 domain agent dispatch — the inventory and routing are already complete.

  ### Automatic Dispatch

  Per user decision: no confirmation prompt. After routing completes, the orchestrator proceeds directly to domain agent dispatch (Phase 3). The user's mental model is "one command does everything."
  ```

  **Update the Instructions section** to add routing steps:
  - Step 8: "Categorize each document into one of 9 domain buckets using filename heuristics and content inspection."
  - Step 9: "Split domains with >20 files into batches of max 20."
  - Step 10: "Update _dd_inventory.json with domain assignments and batch metadata."
  - Step 11: "Update _dd_status.json checkpoint to phase=routing."
  - Step 12: "Display categorization summary to user (counts only)."
  - Step 13: "Proceed to domain agent dispatch (Phase 3)."
  </action>
  <verify>
  Run these checks:
  1. `grep -c "Domain Categorization" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1
  2. `grep -c "Document Routing" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1
  3. `grep -c "BATCH_SIZE=20" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1
  4. `grep -c "uncategorized" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 2
  5. `grep -c "routing_complete" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1
  6. `grep -c "9 domain" dc-due-diligence-desktop/commands/due-diligence.md` — should return >= 1
  </verify>
  <done>
  commands/due-diligence.md contains full domain categorization logic (9 domains with keyword sets), two-pass approach (filename heuristics then content inspection), batch splitting for domains exceeding 20 files, _dd_inventory.json update with routing metadata, and session checkpoint update to phase=routing. No user confirmation prompt — categorization flows automatically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md with domain routing workflow and keyword reference</name>
  <files>dc-due-diligence-desktop/skills/due-diligence/SKILL.md</files>
  <action>
  Update skills/due-diligence/SKILL.md to document the routing workflow and provide the domain keyword reference that both the command and skill files share.

  **Add "## Document Routing Workflow" section** after the "Native Document Reading" section (added by Plan 02-01):

  ```markdown
  ## Document Routing Workflow

  After document discovery and inventory write, the orchestrator routes files to domain agents:

  1. **Categorize** — Two-pass approach:
     - Pass 1: Filename/path keyword matching (fast, no file reading)
     - Pass 2: Content inspection for unmatched files (read first page only)
  2. **Batch** — Split domains with >20 files into batches of max 20
  3. **Update inventory** — Write domain assignments and batch metadata to `_dd_inventory.json`
  4. **Checkpoint** — Update `_dd_status.json` to `phase: routing`
  5. **Dispatch** — Proceed directly to Phase 3 agent dispatch (no user confirmation)

  ### Domain Keyword Reference

  Each of the 9 domains has characteristic keywords used for categorization:

  | Domain | Agent | Primary Keywords |
  |--------|-------|-----------------|
  | power | Power Agent | utility, substation, transformer, MW, megawatt, electrical, grid, voltage, UPS, generator, switchgear, PPA |
  | connectivity | Connectivity Agent | fiber, carrier, latency, bandwidth, network, ISP, peering, dark fiber, cross-connect, route diversity, telecom |
  | water-cooling | Water/Cooling Agent | cooling, water, chiller, HVAC, airflow, temperature, humidity, PUE, WUE, cooling tower, mechanical |
  | land-zoning | Land/Zoning Agent | zoning, parcel, entitlement, setback, easement, lot, acre, building permit, land use, survey, plat |
  | ownership | Ownership Agent | deed, title, lien, mortgage, LLC, owner, entity, beneficial, encumbrance, UCC, litigation |
  | environmental | Environmental Agent | contamination, hazardous, flood, seismic, Phase I, Phase II, remediation, brownfield, EPA, ESA |
  | commercials | Commercials Agent | lease, rent, NNN, CAM, tenant, escalation, term, pricing, rate, cost, revenue, EBITDA, LOI, pro forma |
  | natural-gas | Natural Gas Agent | gas, pipeline, natural gas, BTU, therms, generation, turbine, fuel, backup power |
  | market-comparables | Market Comparables Agent | comparable, market rate, transaction, sale, acquisition, benchmark, competitor, vacancy |

  ### Batch Splitting Rules

  - Maximum 20 files per agent dispatch (platform limit)
  - When a domain exceeds 20 files, split deterministically: files 1-20 in batch 1, 21-40 in batch 2, etc.
  - Each batch is dispatched as a separate agent run
  - No data left behind — every file in a domain gets processed

  ### Uncategorized Files

  - Files matching no domain keywords are logged as "uncategorized"
  - Uncategorized filenames displayed in chat so user can see what was excluded
  - Uncategorized files are NOT routed to any agent
  - Phase 3 synthesis handles partial data gracefully
  ```

  **Update session resilience** section to document the `"phase": "routing"` checkpoint:

  Add to the decision logic:
  ```
  - If `_dd_status.json` shows `phase: routing` AND is < 24 hours old → skip to Phase 3 domain agent dispatch
  - If `_dd_status.json` shows `phase: inventory` AND is < 24 hours old → skip to categorization (routing step)
  ```

  **Update the _dd_status.json schema** in the Checkpoint Write section to show both possible phases:

  ```markdown
  Checkpoint phases:
  - `"inventory"` — file discovery complete, categorization pending
  - `"routing"` — categorization and batch assignment complete, ready for Phase 3 dispatch
  ```
  </action>
  <verify>
  Run these checks:
  1. `grep -c "Document Routing Workflow" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 1
  2. `grep -c "Domain Keyword Reference" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 1
  3. `grep -c "Batch Splitting Rules" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return 1
  4. `grep -c "Uncategorized" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 1
  5. `grep -c "routing" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 3
  6. `grep -c "20 files" dc-due-diligence-desktop/skills/due-diligence/SKILL.md` — should return >= 1
  </verify>
  <done>
  SKILL.md documents the full routing workflow (categorize -> batch -> update inventory -> checkpoint -> dispatch), includes the 9-domain keyword reference table, explains batch splitting rules (max 20 per dispatch), documents uncategorized file handling, and updates session resilience to handle both "inventory" and "routing" checkpoint phases.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Domain categorization:** commands/due-diligence.md has a two-pass categorization approach with 9 domain keyword tables
2. **Batch splitting:** Both files document the 20-file-per-dispatch limit and deterministic batch splitting logic
3. **Inventory update:** _dd_inventory.json schema is updated with domains, batch assignments, and uncategorized files
4. **Session checkpoint:** _dd_status.json supports both "inventory" and "routing" phases with correct resume logic
5. **No confirmation:** No user confirmation prompt in the routing flow — it's fully automatic
6. **Uncategorized handling:** Uncategorized files are listed in chat output per user decision
7. **Consistency:** Domain keyword sets match between commands/due-diligence.md and SKILL.md
8. **20-file limit:** Batch splitting enforces the platform limit — no domain dispatch exceeds 20 files
</verification>

<success_criteria>
- 9 domain keyword sets defined consistently in both files
- Two-pass categorization (filename then content) documented in command file
- Batch splitting logic handles domains with >20 files
- _dd_inventory.json updated with domain assignments and batch metadata before dispatch
- Uncategorized files logged and displayed in chat
- Session resilience supports resume at both "inventory" and "routing" phases
- No user confirmation prompt — routing is automatic
- A 50-file data room can be categorized and routed without exceeding the 20-file limit per dispatch
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-ingestion-and-routing/02-02-SUMMARY.md`
</output>
